{"version":3,"sources":["lib/PermissionService.js"],"names":["permissionService","rep","userService","_this","userInRole","userEntity","roleData","getEntityById","keys","user","id","role","getRole","userRoleEntities","getEntities","userRole","i","length","userId","roleId","userCanDoAction","resourceData","action","permission","getPermission","rolePermission","getRolePermission","toLowerCase","read","create","update","delete","getCanDoActions","inRole","getCurrentUser","canDo","canDoActions","permissionId","rolePermissions","j","data","name","getEntityByName","names","repository"],"mappings":"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","sourcesContent":["'use strict';\r\n\r\nvar permissionService = (function (rep, userService) {\r\n    var _this = {};\r\n\r\n    _this.userInRole = function (userEntity, roleData) {\r\n        if (!userEntity || !roleData) return false;\r\n\r\n        userEntity = rep.getEntityById(rep.keys.user, userEntity.id);\r\n        let role = getRole(roleData);\r\n\r\n        if (role == null || userEntity == null) return false;\r\n\r\n        var userRoleEntities = rep.getEntities(rep.keys.userRole);\r\n        if (userRoleEntities) {\r\n            for (var i = 0; i < userRoleEntities.length; i++) {\r\n                var userRole = userRoleEntities[i];\r\n                if (userRole.userId == userEntity.id && userRole.roleId == role.id) {\r\n                    return true;\r\n                }\r\n            }\r\n        }\r\n        return false;\r\n    };\r\n\r\n    _this.userCanDoAction = function (userEntity, resourceData, action) {\r\n        if (!userEntity || !action || !resourceData) return false;\r\n\r\n        userEntity = rep.getEntityById(rep.keys.user, userEntity.id);\r\n        let permission = getPermission(resourceData);\r\n        if (userEntity == null || permission == null) return false;\r\n\r\n        var userRoleEntities = rep.getEntities(rep.keys.userRole);\r\n        if (userRoleEntities) {\r\n            for (var i = 0; i < userRoleEntities.length; i++) {\r\n                var userRole = userRoleEntities[i];\r\n                if (userRole.userId == userEntity.id) {\r\n                    var rolePermission = getRolePermission(userRole.roleId, permission.id);\r\n                    if(rolePermission == null) continue;\r\n                    switch (action.toLowerCase()) {\r\n                        case 'read':\r\n                            return rolePermission.read;\r\n                        case 'create':\r\n                            return rolePermission.create;\r\n                        case 'update':\r\n                            return rolePermission.update;\r\n                        case 'delete':\r\n                            return rolePermission.delete;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        return false;\r\n    };\r\n\r\n    _this.getCanDoActions = function (userEntity, resourceData) {\r\n        if (!userEntity || !resourceData) return false;\r\n\r\n        userEntity = rep.getEntityById(rep.keys.user, userEntity.id);\r\n        let permission = getPermission(resourceData);\r\n        if (userEntity == null || permission == null) return false;\r\n\r\n        var userRoleEntities = rep.getEntities(rep.keys.userRole);\r\n        if (userRoleEntities) {\r\n            for (var i = 0; i < userRoleEntities.length; i++) {\r\n                var userRole = userRoleEntities[i];\r\n                if (userRole.userId == userEntity.id) {\r\n                    var rolePermission = getRolePermission(userRole.roleId, permission.id);\r\n                    if(rolePermission == null) continue;\r\n                    return {\r\n                        read: rolePermission.read,\r\n                        create: rolePermission.create,\r\n                        update: rolePermission.update,\r\n                        delete: rolePermission.delete\r\n                    };\r\n                }\r\n            }\r\n        }\r\n        return false;\r\n    };\r\n\r\n    _this.inRole = function (roleData) {\r\n        return _this.userInRole(userService.getCurrentUser(), roleData);\r\n    };\r\n    _this.canDo = function (resourceData, action) {\r\n        return _this.userCanDoAction(userService.getCurrentUser(), resourceData, action);\r\n    };\r\n    _this.canDoActions = function (resourceData) {\r\n        return _this.getCanDoActions(userService.getCurrentUser(), resourceData);\r\n    }\r\n\r\n    function getRolePermission(roleId, permissionId) {\r\n        var rolePermissions = rep.getEntities(rep.keys.rolePermission);\r\n        if (rolePermissions) {\r\n            for (var j = 0; j < rolePermissions.length; j++) {\r\n                var rolePermission = rolePermissions[j];\r\n                if (rolePermission.roleId == roleId && rolePermission.permissionId == permissionId) {\r\n                    return rolePermission;\r\n                }\r\n            }\r\n        }\r\n        return null;\r\n    }\r\n\r\n    function getRole(data) {\r\n        let role = null;\r\n        if (data.id)\r\n            role = rep.getEntityById(rep.keys.role, data.id);\r\n        else if (data.name)\r\n            role = rep.getEntityByName(rep.keys.role, data.name);\r\n        else if (data.names) {\r\n            for (var i = 0; i < data.names.length; i++) {\r\n                role = rep.getEntityByName(rep.keys.role, data.names[i]);\r\n                if (role != null) break;\r\n            }\r\n        }\r\n        return role;\r\n    }\r\n\r\n    function getPermission(data) {\r\n        let permission = null;\r\n        if (data.id)\r\n            permission = rep.getEntityById(rep.keys.permission, data.id);\r\n        else if (data.name)\r\n            permission = rep.getEntityByName(rep.keys.permission, data.name);\r\n        else if (data.names) {\r\n            for (var i = 0; i < data.names.length; i++) {\r\n                permission = rep.getEntityByName(rep.keys.permission, data.names[i]);\r\n                if (permission != null) break;\r\n            }\r\n        }\r\n        return permission;\r\n    }\r\n\r\n    return _this;\r\n})(repository, userService);"],"file":"PermissionService.js"}